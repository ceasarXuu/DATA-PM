# 用户唯一标识

## 概述

- 为什么要唯一标识用户？

    唯一确定一个用户，是用户数据分析的基础，将一个用户在多种场景的行为关联合并，才能尽可能接近用户的真实使用场景。

- 唯一标识用户的困难是什么？
    1. 给用户生成唯一标识，受限于用户的使用场景，理想情况是用户登录账户，可以突破终端限制。对于未登录用户，只能根据可取得的用户信息（如cookie、设备唯一id等）生成一个访问ID，访问ID的有效性取决于生成方案中使用数据的用户身份关联性、ID稳定性，如移动设备IMEI号，一个设备始终不变，用户更换设备的频率低，而cookie由浏览行为生成，cookie失效频率高，所以由IMEI号取得的访问ID要优于cookie下发的访问ID
    2. PC、web、H5、APP多种终端，将用户在多平台行为关联起来，算法上有难度（可用的关联数据少，数据分散）主线程我
    3. 基于非账号的用户信息生成的唯一ID具有局限性，当用户跨出生成这个ID的场景，ID基本就无效了。
    4. 隐私保护政策下，获取用户的强关联信息越来越困难，一个能够强力跟踪用户的标识，是非常危险的，目前最好的情况就是在关注的场景内有权威官方提供的稳定标识。如iOS系统的IDFA

## 唯一标识的生成策略

基于注册账户的唯一标识可靠性很高，生成策略的主要难点在于如何标识未登录的用户。

当用户提供的数据中，有关联性强，可信度高的字段时，将其作为唯一ID；当提供信息不足以直接作为唯一ID时，将可采集到的信息与用户ID库中的参考信息（如设备型号、IP、UA等）对比，根据算法判断其与已存在用户的相似度，相似度达到一定水平时，则认为该用户就是已存在的某用户，则下发已有的唯一ID给该终端的数据采集使用，并将新采集到的信息纳入到该用户的特征中。若无法找到相似度足够的已存在用户，则随记生成一个新的唯一ID下发该用户，标记为新用户，纳入用户库中。

用户库要根据新纳入的数据不断进行更新合并，两个唯一ID，当收集到足够多的信息、算法相似度达到一定程度时，可以进行用户合并，涉及到用户ID的层次问题。

【待研究】一个产品应该有一个superID，superID在层级上应该是高于passport、device的，用于将多终端、多设备、多账号情况的用户进行最终合并。

同一用户的当前唯一ID变化，取决于使用场景和使用的ID。

1. 登录用户的账户始终不会变
2. 唯一ID存储在cookie中时，由于cookie持久化能力很差，随着缓存的清空（主动清空、重装等都会导致），cookie就会消失，下次下发cookie时，唯一ID是否发生了变化，取决于算法时候能识别出这是某个已存在的设备。

## 唯一标识的使用

在数据采集场景，要使一个用户的数据上报持续关联在唯一ID下，需要把唯一ID进行本地存储。

基于web/h5浏览器的场景，唯一ID都会被存储在cookie中，在用户使用网站的过程中，可以一直从cookie中取得

ios系统目前可以存储在keychain中，Android系统可以进行加密后存储在本地文件系统中



### 常用的设备ID总结

#### 1. Android设备

| 名称       | 说明                                                         | 格式                                                         | 获取方式                                                     | 应用                                                         |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| IMEI       | 国际移动设备识别码（International Mobile Equipment Identity）相当于移动电话的身份证，存在主板内存中，双卡双待手机有两个imei号。用于GSM设备。不会改变 | 15~17位，十进制，前8位（TAC）是型号核准号码（早期为6位），是区分手机品牌和型号的编码。接着2位（FAC）是最后装配号（仅在早期机型中存在），代表最终装配地代码。后6位（SNR）是串号，代表生产顺序号 | 安卓8.0以上用getImei获取，8.0以下用TelephonyManager.getDeviceId()，需要获取READ_PHONE_STATE 权限 | 重装APP不会改变                                              |
| MEID/ESN   | 移动设备识别码(Mobile Equipment Identifier)，类似imei，用于CDMA制式的移动设备 | 14位，十六进制，RR – 有效范围 ’99’, ’98’, ’97’ ，全球统一管理；XXXXXX – 有效范围 000000--999999；ZZZZZZ – 有效范围 000000-- 999999；C – 有效范围 0 -- 9 – 不参与空中传输。 | 安卓8.0以上用getMeid获取，8.0以下用TelephonyManager.getDeviceId()，需要获取READ_PHONE_STATE 权限 | CDMA设备返回的，一般不使用                                   |
| MAC        | 网络地址（Media Access Control Address）在网络中唯一标识一个网卡，一台设备中的多个网卡有多个MAC地址，烧制在网卡EPROM中。包括WiFi mac地址和蓝牙mac地址 | 48位，二进制，常表示为12个16进制数，前6个是制造商编号，后6个是网络产品（网卡）的系列号 | INTERNET、ACCESS_WIFI_STATE、ACCESS_NETWORK_STATE<br /> Android 6.0之后被禁止，若获取则会被判定为有害应用。 | 用于确认网络设备位置，一般与IMEI一起使用定位一台设备         |
| IMSI       | 国际移动用户识别码	（International Mobile Subscriber Identity）用于蜂窝网络中唯一确定一个用户，存在SIM卡（CDMA2000中存在手机或RUIM），双卡手机只返回一个IMSI，用户换手机、换卡不换号，都不变 | 最大15位，绝大多数为15位，十进制。	由移动国家代码（MCC，Mobile Country Code）、	移动网络代码	（MNC，Mobile Network Code）和移动订户识别代码（MSIN，Mobile subscription identification number）依次连接而成 | READ_PHONE_STATE<br/>TelephonyManager.getSubscriberId()      | 用户更换手机时仍可使用                                       |
| ICCID      | SIM卡卡号（Integrate circuit card identity）用于区分每张SIM卡，可以伪造，双卡手机只返回一个ICCID | 19~20位，少数6/12位，十进制。前6位是运营商代号               | READ_PHONE_STATE<br/>TelephonyManager.getSimSerialNumber()   | 区分运营商                                                   |
| UUID       | 通用唯一识别码(Universally Unique Identifier)，由随机算法得到的伪唯一识别码（重复概率为170亿分之一），每次获取都会改变。应用最广泛的是微软的GUIDs |                                                              |                                                              | 用于生成UDID                                                 |
| UDID       | 设备唯一标识符（Unique Device Identifier），通常是非系统原生的，开发商自定义解决。 |                                                              |                                                              | 获取UUID后，写入.so文件生成UDID。即使APP重装，值也不变，除非root手机（普通用户做不到） |
| Android_id |                                                              |                                                              | 安卓8.0开始提供                                              |                                                              |

#### 2. iOS设备

| 名称     | 说明                                                         | 格式                                                         | 获取方式       | 应用                                                         |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------------- | ------------------------------------------------------------ |
| IDFV     | 应用开发商标识符（Identifier For Vendor），同一开发商的应用的IDFV都一样。当用户卸载某应用商的所有应用，重装该应用商的应用时，IDFV改变 | 通过CFBundleIdentifier（DNS反转格式）的前两部分生成，如：com.cjh.one和com.cjh.two得到的IDFV是一样的。如（583D2BB0-B19C-4A9A-A600-2A1EB2FB7E39 ） |                |                                                              |
| IDFA     | 广告标识符（Identifier For Advertising）苹果专门给各广告提供商用来追踪用户而设的，由系统存储，用户可以主动还原隐私、还原广告标识符、开关IDFA开关、充值系统来改变这个值。同一设备的所有应用拿到的都是同一个IDFA |                                                              |                | 跨应用的用户追踪、广告推广                                   |
| UUID     | 通用唯一识别码(Universally Unique Identifier)，由随机算法得到的伪唯一识别码（重复概率为170亿分之一），每次获取都会改变。应用最广泛的是微软的GUIDs |                                                              |                | 将第一次获取的UUID存到keychain中，之后每次都使用keychain，就成为不变的唯一ID |
| IMEI     | 国际移动设备识别码（International Mobile Equipment Identity） |                                                              | ios5后禁止获取 |                                                              |
| UDID     | 设备唯一标识符（Unique Device Identifier）可以唯一锁定一台设备，只有越狱可以改变 |                                                              | ios5后弃用     |                                                              |
| OpenUDID | 开源方案，利用剪切板在不同应用间共享一个OpenUDID             |                                                              | ios7后弃用     |                                                              |
| MAC      | 网络地址（Media Access Control Address）                     |                                                              | ios7后禁止获取 |                                                              |