# 埋点

本篇从数据产品经理的角度，描述埋点的定义、原理、埋点工作的核心问题与方案。

## 1. 概述

#### 1.1 什么是埋点

埋点是互联网应用中，采集数据的一种方式。类比高速公路上的测速仪，是一种触发性的数据采集，每当车辆路过测速仪时，车辆的速度、外观、车牌号等信息会被测速仪收集。在互联网应用中即**通过代码记录【事件】**。事件的概念很宽泛，上述例子的“汽车驶过测速仪”就是一个事件，其他如用户在网页中点击了某个按钮、购买了某件商品等等，事件是埋点的核心概念。

一个埋点信息的组成可能是这样的——“用户A在9号晚上21点购买了商品B。” 其中【购买商品】是核心事件，【用户A】【9号晚上21点】【商品B】则是事件的现场环境。各种各样的埋点记录不同的事件与环境，每触发一次产生一条消息，这些消息汇聚起来就是埋点的产物。

在互联网应用中怎么设置“测速仪”呢？ 埋点的原理：

1. 当系统/软件运行时，会产生各种系统消息来反映系统的运行状况，捕捉这些消息进行加工（传递、计算等）。如
2. 埋点的本质就是重写（override）系统的方法。可以理解为，重新定义软件的“行为”，比如你平常

将系统的现场消息转变为数据团队、产品运营团队可理解的信息，为数据分析、计算等服务提供基础的数据“弹药”。

埋点到的采集的数据通常会经历以下过程：

1.  数据生产者：客户端或服务端，通过埋点生成日志数据（消息），传给管道/中转站

2.  管道/中转站：是消息的收集、处理和发布系统，收集各个数据发送方的数据并进行简单的处理和临时存储，供数据消费者使用

4.  数据消费者：各业务服务端、数据分析平台等，从管道获取数据，根据需求做深度开发和持久存储

埋点是数据生产的**源头**，埋点的质量（数据量、粒度、易用性等）很大程度上影响到后续的每一个环节。



#### 1.2 怎样才算合适的埋点

怎么用，决定了怎么埋。埋点数据常见的应用场景有：

1.  记录用户的行为：产品功能优化；基于用户画像的精细化运营、推荐、营销等；风控
2.  记录业务数据：支持业务功能；业务数据分析
3.  记录系统状况：供开发人员在系统优化时参考

为了满足这些应用场景，通常有以下几方面的要求：

1.  覆盖度：数据采集能否覆盖需要关注的场景
2.  粒度：数据能精细到什么程度？全站？某个场景？还是单次行为？
3.  维度：能支持从哪些角度去解读数据
4.  时效性：通常情况下数据的价值随时间降低，越快取得数据，越能发挥数据的价值
5.  准确性：能否满足不同使用场景下对数据的准确度要求，95%？99%？100%？

围绕以上要求，埋点工作有以下几个核心问题需要解决：

1.  WHERE —— 埋点位置
2.  HOW —— 如何实现埋点
3.  WHEN —— 何时触发埋点
4.  WHAT —— 采集什么内容
5.  HOW  —— 数据如何上报



## 2. 埋点位置

即埋点代码要写在哪里。代码位置的选择，关系到数据生产的覆盖度、可靠性和效率。

#### 2.1 客户端埋点(app/h5/web）

客户端即用户设备上的应用，是用户与产品交互的第一现场，用户在客户端的任何操作都可以被感知记录。

客户端作为数据生产者有以下优势：

1.  可以较全面的采集用户的设备和网络信息：操作系统给应用提供了各种采集设备数据的方法。
2.  可以感知到用户在应用中的几乎所有行为

这两个优点决定了业内绝大多数方案都采用了客户端埋点方案，但客户端埋点缺点同样明显：

1.  **生效周期长**：代码写在应用包里，需要等待应用商店审核、上架、用户更新程序的漫长过程才能生效。新增的埋点只能从某一个版本开始向后收集数据，无法覆盖不升级的老用户，而等待大部分用户更新，不同的产品需要的时间不同，有些可能要两周甚至更久。对于新增的业务可能影响不大，但是对于旧业务的新埋点，则很长一段时间都无法取得全面准确的数据。此外这种方式的容错率也很低，一旦某个版本上线后发现bug，很有可能导致某些数据被长期污染。
2.  **受本地存储空间和流量制约**：采集数据量大时，需要的缓存空间和上传数据时耗费的流量也相应变大，为了保证产品性能和用户体验，需要采用延时上报、压缩打包上报等策略，就降低了数据采集的时效性和准确性（打包上报丢包率更高）。
3.  **受客户端稳定性影响**：客户端会因为各种意外情况，导致程序运行中断或无法传输数据，如接听电话、退后台、杀死APP、死机、断电、断网等，有些情况可以将数据保存在本地，等待正常运行时再上报，这样时效性会被降低。有些情况如突然死机等，数据可能就来不及被保存，直接丢失。

适合采用客户端埋点的事件：

1.  无需服务端响应、在客户端即可完成的事件：
2.  需要统计服务端请求失败情况的事件：请求失败时服务端无法感知，在前端埋点用于补全场景或进行异常分析；
3.  时效性、准确性要求不高的事件：客户端永远不可能保证及时的、100%不丢失的上报数据。

#### 2.2 服务端埋点

即在提供某项服务的服务器上埋点，原理是当用户在使用某项功能时，可能向服务端发起请求，这个过程可以被感知到，采集数据生成日志。

服务端作为数据生产者的优势：

1.  上线更新只需服务端发版即可一次完成，上线即生效
2.  低延迟、可靠传输，有条件保证数据被及时的、100%完整的上报

同样的，由于远离用户侧，服务端埋点也有明显弊端：

1.  无法感知到不需要服务端参与的事件：如用户上传头像需要服务端响应，但是浏览本地相册、点选图片、裁剪图片的过程，服务端并不参与。
2.  天然只关心业务需要的数据：如购买视频网站的会员，服务端只关心账户、会员等级、商品属性等，用户的设备型号、网络状态等信息，与其业务可能没有任何关系。且这些数据只能首先通过客户端获取后，再发送给服务端，除非有强烈的数据分析需求，服务端没有采集的必要性和动力。这就导致很多业务相关的数据采集和分析工作有阻力。

适合采用服务端埋点的事件：

1.  基本要求是必须有服务端参与
2.  对时效性、准确性要求高的事件：如涉及交易的购买、支付，涉及互动的评论、聊天等。

除了服务端不参与的事件，其他应尽量使用服务端埋点，部分内容需要由客户端采集，在想服务端发起请求时一并发送，由服务端整合上报。对于可能请求失败的情况，可以用客户端埋点的方式补充。

此外，从服务端采集数据，除了使用服务端埋点的方式，还可以直接读取业务数据库，这样做的好处是省去了埋点的工作，坏处是数据计算与业务耦合了，采集的是经过业务计算处理的数据，并不一定能满足其他使用需求。



#### 2.3 客户端埋点 vs 服务端埋点

|                | 客户端                                   | 服务端                       |
| -------------- | ---------------------------------------- | ---------------------------- |
| 设备与网络信息 | 有必要且容易获取                         | 通常不关心且无法直接获取     |
| 用户行为采集   | 全部可获取                               | 只能获取到有服务端参与的行为 |
| 业务数据采集   | 可获取，<br />但无法保证失效性和100%可靠 | 及时、≈100%准确可靠          |
| 代码更新       | 依赖用户更新，生效周期长                 | 上线效率高、上线即生效       |

两种方案都没有绝对的优势，如需要进行用户行为路径分析，客户端埋点必不可少，要结合分析业务数据，则服务端埋点必不可少。目前业内商业化的数据平台、或有实力的企业，采用的都是客户端+服务端埋点的策略。





##  3.实现方式

这部分从  “埋点实现的自动化程度”  角度来看埋点的实现方式，不涉及具体的开发（俺也不懂）。埋点工作由于其复杂性（产品场景可能极多），写代码的效率也是一个重要问题。



#### 3.1 代码埋点/自定义埋点

即根据具体的需求，**只对关注的内容**进行**指定粒度、指定维度**的监控，是目前埋点方案的主流形式。

原理：关注的内容被触发时，调用相应的方法，发送埋点数据。如点击某个按钮时，在按钮点击onclilck函数中调用埋点SDK方法，上报数据。

优势：

1.  单次需求轻便灵活，来一个埋一个
2.  自定义能力强，可以针对性的统计很多维度的属性、自定义属性

劣势：

1.  沟通成本高：关心这个埋点数据的所有人，运营、产品、前后端开发、数据团队，都需要沟通达成共识
2.  重复操作：同一类型组件可能每新增一个都要再埋一次
3.  当产品形态复杂时，埋点的管理和维护工作十分困难

适用场景：

1.  需要细粒度、多维度的深入分析时，需要

#### 3.2 全埋点/无埋点

原理：对于**所有**可能关注的系统事件（如控件的加载成功、浏览、点击、播放等），**自动地**采集并存储，当需要的时候，**找到关心的数据**，进行处理和分析。

优势：

1.  全面的采集，提供埋点“后悔药”。一切设定范围内的事件都将被统计，比如有3个按钮A、B、C，你目前只分析其中按钮A的点击情况，并不关心B和C有没有人点，但这2个按钮的点击情况依然会被记录下来。当你有一天突然关心B和C了，只需要找到这些数据就可以用。
2.  自动采集：全埋点的核心是自动化，当埋点SDK部署后，任何规范范围内的控件事件，都会被自动部署埋点代码，无需开发人员额外操作。降低了开发和沟通成本，且自动化采集的数据会更加规范、统一，方便后续处理。
3.  关键词3——找到关心的数据：全量数据那么多，哪些才是我关心的数据呢？就好比在全校学生中找某个班的学生，你就必须知道要找的班级号，全埋点中控件/事件的数据，同样要有能够唯一识别的方式。这需要一套规定好的方案，使用唯一的控件路径、唯一的控件名等。唯一标识设计为自动生成，一次开发成本高，但维护成本低，或者手动给控件命名，后期维护麻烦。

补充关键词：可视化埋点可视化埋点是全埋点方案的一种，通常全埋点指在SDK部署时就开始尽可能收集所有数据，只在分析阶段通过可视化的配置选择要分析哪些数据，可视化埋点的理解有两种，一是在全埋点的基础上提供了可视化的配置方式，二是在配置了想要收集的数据之后才开始向后收集，没有历史数据。

劣势：

1.  传输成本高：大量采集耗费了更多的客户端流量，通常采用打包压缩的方式缓解；
2.  存储成本高：所以通常对于未关注的数据，设置销毁时限，到期未被使用的数据将被删除。
3.  对于按照路径确定唯一控件的方案，在控件路径修改时，数据的使用方案也要随之修改。
4.  对于复杂的场景，一些自定义属性难以针对性地实现，需要结合手动代码埋点。

结合以上特点，全埋点适用于：

-   无需深入分析（自定义能力差）
-   业务多变（较低的开发和沟通成本）
-   页面逻辑变化少（降低数据使用的复杂度）



个人认为代码埋点和全埋点之间并没有绝对的区别，只是在“人力成本”和“有限的自动化”之间的权衡。



##  4. 埋点时机

即触发埋点的条件。可以用 4W1H 描述具体在什么场景下触发埋点。如当用户在详情页点击购买按钮时。

记录下埋点触发的时间，还可用于路径分析，如对某用户的页面曝光事件，按触发事件排序，可得到其页面路径。但是要注意，对于在短时间内发生多个事件、且用户未操作的情况，埋点触发的先后顺序可能不是确定的，如：APP启动的短时间内会经历启动图加载、广告曝光、浮层弹出、权限弹窗等许多事件，他们在代码中不一定是同一模块顺序执行的，可能有时A事件先发生，有时B事件先发生，要考虑上报顺序对路径分析的影响



##  5. 采集内容

#### 5.1 数据来源

客户端：客户端程序能够感知的所有内容，包括用户操作、系统进程等

服务端：同步服务端日志或进行服务端埋点，常用于前端无即时感知的事件统计（如审核结果）、精确统计业务数据（和业务调用是同步的）



#### 5.2 事件

事件 = 环境+实体属性+行为+其他自定义属性

##### 3.2.1 环境

时间：操作发生的时间；操作持续的时间

空间：

-   现实空间：GPS；
-   设备空间：网络（3G/4G/5G/wifi、ip）；设备信息（厂商、型号、imei、操作系统）
-   应用空间：应用版本；应用内位置来源：从什么地方来到了当前场景

##### 3.2.2 实体

实体包括用户

**用户**

人口、社会属性：姓名、性别、年龄、常住地、职业、消费能力、偏好等

业务属性：用户在平台内的身份、偏好、安装渠道、注册渠道等

**用户的唯一标识**

什么是一个用户的唯一标识？为什么要唯一标识？

身份证就是最常见和易理解的唯一标识。唯一标识代表一个用户在系统中的身份，在用户画像构建、行为分析、漏斗分析等几乎任何数据分析的场景都必不可少，常用的唯一标识有注册账号、设备号、手机号等。

唯一标识一个用户所面临的问题

-   用户行为：实际情况中用户的行为很复杂，一个用户可能有多个账号或多个设备、一个设备上有多个用户的多个账号、一个账号在多个设备上登录、或用户无登录；将设备号视为一个用户将会忽视一号多机的情况、将一个账号视为一个用户会忽视多人共用的情况，需要结合具体业务场景决定方案
-   覆盖度：不同字段的覆盖度也不同，有些可能因为隐私等原因难以获取（如身份证、手机号、imei号），或天然覆盖不全（如游客用户）
-   安全性：在生产、传输和存储的过程中有可能泄露用户隐私
-   稳定性：用户的任何唯一标识都是有可能会发生变化的，身份证、手机号的变更属于不可控的，但对于同一设备安装的同一应用，应保证设备id是唯一的，不因卸载重装、升级等原因发生变化

**客体（行为对象）**

定义：被操作对象可能是控件或被理解为一个内容（文本、图片、音视频）

唯一标识：控件在某些场景下也有唯一标识的需要，如区分同一类按钮在不同位置的点击，通过技术方案可以比较容易地解决

常用的属性：物品/内容/信息id（商品id、视频id、消息id等）；分类id（如专辑id、播单id、收藏夹id等）；时长、清晰度、分辨率、音质、尺寸、文件大小等文件信息

**行为**

主动行为：用户具体操作如点赞、评论、搜索、购买；

被动行为：如评论失败、审核通过、push接收、广告弹窗等

为降低数据上传压力，常用actionId（行为id，数字或简单字符串）来代表不同的行为，在埋点管理系统中对actionId代表的行为进行详细描述；被动行为要考虑上报时机和来源，app是否存活、客户端报还是服务端报。

**其他自定义属性**

通常出于分析目的自定义的生成属性。

计时类字段：统计某个事件持续的时间，上报前直接计算出时间段或者上报消息时间点，后续处理中计算时间段。

路径类字段：用于统计某个事件用于追踪一个完整行为的来源、去向、或一个session内的所有操作等，如APP启动时生成一个stratId，该用户在退出APP前的所有数据都附带这个字段值，这些数据被视为用户单次启动所产生的行为；或从某个渠道安装或调起APP的，在有效期内都带上渠道id。

反作弊类字段：防刷码等

##### 3.2.3 事件设计原则

1.详细：任何业务会关心的内容都可以作为事件去统计，常见的如用户行为、系统性能等

2.一致性：若产品在iOS、Android、ipad等多平台，对于同一事件的口径、名称、埋点时机、上报数据等应完全一致

3.必要的冗余：上报内容中其实有很多字段都是冗余的，在一些服务端通过关联可以得到，但是当数据量很大时，关联计算相当困难，冗余上报可以减少关联步骤

4.复用：当现存的事件无法很好的解释新场景，或通用字段无法覆盖新增场景值时，再新增一个事件，否则尽可能的复用。但也要避免过度复用，复用通常会导致‘部分修改、全部改变’的情况，不够灵活。复用时要考虑将来是否有可能被大规模使用，若有可能，则要提前做好准备，看该模式是否具有大规模生产、开发的性能，如不能满足，要及时优化，避免规模过大以后难以优化。

#### 3.3 字段设计

流程：首先建立业务数据模型，再逆推到底层需要的字段

内容：尽可能全面的采集当时的环境数据，提供了更多维度也更方便还原现场；做必要的冗余，用于减少下一步的数据开发工作量；尽量的复用已有的字段，减少开发量

拓展性：原有的字段可能无法满足需求，但是也没有必要进行基础字段改造时，使用拓展字段，在数据开发时进行二次加工产生新字段，如套娃一个字符串类型的字段，用JSON字典或URL parameters存储拓展参数，便于二次加工处理

一致性：口径、字段类型和规范保持一致，字段类型不一致会数据开发流程中的计算问题，口径不一致则数据不具备可用性，或需要重新开发

字段值的获取：接口获取，业务系统返回的业务数据、实体的属性数据、统计系统下发的标识数据等；前端自定义固定值、判断值、计算值

#### 3.4 埋点时机



#### 3.5 质量与效率

排重：减少无意义重复数据的干扰

减压：屏蔽不必要的数据采集

取值明确：可全部枚举的取值（默认值、错误值、正常值区间）



## 5. 数据的上报

#### 5.1 上报时机与方式

主要从可靠性和即时上报，通常用于对时效性要求较高的；延时上报，通常用于给数据量较大的场景减压，数据打包压缩后上报，丢包率高。

上报条数：单条发送；积累一定数量打包发送

#### 5.2 传输方式

**http协议传输**

url传参、contents传参

post方法和get方法

**传输性能**

安全性：客户端数据加密**，**防止数据泄露、防止恶意伪造数据进行作弊操作（加密的数据难以仿造）

可靠性：上报数据都先缓存在本地，上报成功或达到一定条件之后再删除，对于重要的数据，使用失败重试机制，数据上报应返回上报情况，失败时有限次的重复尝试，达到失败次数上限时等待下个时机重试，（数据接收和清洗环节，要考虑错误的重试产生的大量重复数据。）；数据丢失的容忍程度根据使用场景决定，看趋势数据、整体分析等，不需要过于精确，用于重要核心业务、设计支付、订单等，要求尽可能100%可靠

时效性：实时上报、延时上报（考虑性能）

性价比：延时上报、打压缩包上报可以缓解流量和带宽开销；简化数据，上报文档中约定好的map-key，如1=成功；2=失败，而不是success/failure



## 6. 数据的预处理、存储与开发







## 7. 埋点管理

接口与格式、事件、表





## 8. 埋点工作的日常

#### 8.1 工作流程闭环

了解业务流程：根据业务流程，选择一种或多种数据采集方案；尽量在业务开发前介入，帮助共同制定既有利于业务健康使用数据、也利于数据采集的系统。

调研行业情况：和业务人员共同确认关键指标和流量模型

确认埋点方案：

没有任何单独的角色知道应该采集哪些数据

测试：

#### 8.2 SQL民工

无情的取数机器



#### 8.3 容忍不完美

容忍【不完美】、【不准确】、【不全面】、【被污染】



## 参考文章

1.  神策数据-技术文档 https://manual.sensorsdata.cn/sa/latest/

2.  PMCAFF 《数据产品经理：埋点的设计、管理与应用》https://mp.weixin.qq.com/s/mjnpTAR0HKx-YexA9H5VIg





测试。。。。。。。。。。。。。。。。。。